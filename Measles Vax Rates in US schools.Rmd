---
title: "Who's Getting Vaccinated for Measles in U.S. Schools?"
author: "*Abby Isaacson*"
date: "3/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

> Could student vaccination rates for Measles, Mumps and Rubella (MMR) possibly predict COVID-19 vaccination rates among children, once a safe child vaccine becomes available?

Measles is disease that was essentially suppressed for 25 years in the U.S. through vaccination, but **showed a significant resurgence** in 2019.

This report examines data from 32 states that collected student measles, mumps and rubella (MMR) vaccination data for kindergarteners between 2017 and 2019. By looking at how many students have been abiding by state vaccine recommendations for MMR, public health organizations and schools may better target future vaccination outreach efforts for COVID-19 to prevent disease outbreaks among students in the future.

```{r}
library(tidyverse)
library(janitor)
library(skimr)
```

#Get the Data
```{r}
measles <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-25/measles.csv')
```
##*Note: How can I export the measles dataset to my data-raw folder, or my local device?

```{r}
measles
```
```{r}
measles <- measles %>% 
  clean_names()
```
# About Reporting Schools

46,412 schools from 32 states reported overall and MMR vaccination rates in the 2017-2018 or 2018-2019 school years, with as many as 16,098 schools reporting from the large state of CA and as few as 230 from small Rhode Island. Among schools that reported school type, most were public (20,692), followed by private and kindergarten only, and then much smaller representation of charter, nonprivate and BOCES (a New York combined education services model, of which there were 42).
##Number of Schools Reporting Vaccination Data, by State

```{r}
measles %>% 
  count(state)
  # %>% 
#arrange(n)
```
#schools by type
```{r}
measles %>% 
  count(type) %>% 
  drop_na(type) %>% 
  arrange(n)
```
#Add something about geography, or map school locations TBD

#Maybe look at schools by year, which reported for 2017-18 vs 2018-19

# Average Vaccination Rates Among Reporting Schools

##create new variables excluding negative (-1) vaccination rates for both mmr and overall variables (not reported).

```{r}
measles_pos <- measles %>% 
  filter(mmr >= 0, overall >= 0)
```

```{r}
measles_mmr_pos <- measles %>% 
  filter(mmr >= 0)
```

```{r}
measles_overall_pos <- measles %>% 
  filter(overall >= 0)
```


#Mean US Measles Vaccination Rate
```{r}
mean_mmr_rate_2 <- measles_mmr_pos %>% 
  summarize(mean_mmr_rate = mean(mmr)) %>% 
  pull(mean_mmr_rate) %>% 
  round()
```

```{r}
mean_mmr_rate_2
```

#Mean US Vaccination Rate overall
```{r}
mean_allvax_rate <- measles %>% 
  summarize(mean_allvax_rate = mean(overall)) %>% 
  pull(mean_allvax_rate) %>% 
  round()
```

```{r}
mean_allvax_rate_2 <- measles_overall_pos %>% 
  summarize(mean_allvax_rate = mean(overall)) %>% 
  pull(mean_allvax_rate) %>% 
  round()
```


```{r}
mean_allvax_rate
```
The mean vaccination rates among reporting schools was at or near the WHO recommendation of 95% needed to achieve herd immunity. The MMR rate among schools (`r mean_mmr_rate_2`%) was slightly higher than the overall reported vaccination rate (`r mean_allvax_rate_2`%). Among the eight states with average MMR vaccination rates above 95%, Illinois and Massachusetts reported the two highest rates (97.4%, 97.09%).  Arkansas reported the lowest mean vaccination rate (80.5%).

#Mean Measles Vaccination Rates by State (if Reported)
```{r}
measles_mmr_pos %>% 
  group_by(state) %>% 
  summarize(mean_mmr_rate = mean(mmr)) %>% 
  arrange(desc(mean_mmr_rate))

```


#Mean overall rates by state to see if trends are similar
```{r}
measles_overall_pos %>% 
  group_by(state) %>% 
  summarize(mean_allvax_rate = mean(overall)) %>% 
  arrange(desc(mean_allvax_rate))
```

Five reporting states showed overall vaccination rates at or above 95% with North Carolina leading (96.83%). California was the only state with sufficient rates for both overall and MMR. 

#---CHALLENGE: Add side-by-side BAR CHARTS for overall vs. mean rates by state; not all states reported both using position = dodge


#Save the data frame: Mean MMR Vaccination rate by state
```{r}
mean_mmr_by_state <- measles_mmr_pos %>% 
  group_by(state) %>% 
  summarize(mean_mmr_rate = mean(mmr))
```
```{r}
mean_mmr_by_state
```


#Mean MMR Vaccination Rates by State and School Type
```{r}
mean_mmr_by_state_type <- measles_mmr_pos %>% 
  group_by(state,type) %>% 
  drop_na(type) %>% 
  summarize(mean_mmr_rate = mean(mmr)) 
#%>% 
  #round(mean_mmr_rate, digits = 1)
```
```{r}
mean_mmr_by_state_type
```


#US Measles Vaccination Rates by School Type Only

Mean MMR vaccination rates varied somewhat by school type. Public schools tended to report the highest mean MMR rates compared to other types, with the exception of New York's BOCES (Boards of Combined Educational Services) schools (similar to public rates). 
```{r}
mean_mmr_by_type <- measles_mmr_pos %>% 
  group_by(type) %>% 
  drop_na(type) %>% 
  summarize(mean_mmr_rate = mean(mmr)) %>% 
  arrange(mean_mmr_rate)
```
```{r}
mean_mmr_by_type
```

# Exemptions (Section Needs Reworking)

The most common type of exemption reported by schools was personal, followed by medical. Religious exemptions were only reported by 0.16% of schools. Washington was the only state that reported all three types.

#Figure out what % took any exemption at all

#Percent of All Schools with Religious Exemptions
```{r}
measles %>% 
  count(xrel) %>% 
  mutate(n = 100 * n / sum(n))
```
```{r}
measles %>% 
  count(xmed) 
```

```{r}
measles %>% 
  count(xper)
```

#Percent of Exemptions by State and School Type
```{r}
measles %>% 
  group_by(state) %>% 
  count(state,type,xrel,xmed,xper)
```
##*Note: how to combine or average % for each exemption by type and state would be a next step I'm not ready for.

#Exemptions by State
```{r}
measles %>% 
  group_by(state,xrel,xmed,xper) %>% 
  drop_na(xrel,xmed,xper) %>% 
  summarize(mean_mmr_rate = mean(mmr))
```

install.packages("usethis")
library(usethis)

#-----take this to a repository ------
use_git()

#send to github
use_github(organisation = "rin3-spring-2021", private = TRUE)

# Visualizations 

##Scatterplot of vax rate and personal exemptions. I don't think this dataset has good numeric variables to scatterplot sensibly. 


```{r}
  ggplot(data = measles_mmr_pos,
       mapping = aes(x = mmr, y = xper, color = overall)) +
  geom_point() +
  facet_wrap(~type)
```

```{r}
ggplot(data = measles_overall_pos,
       mapping = aes(x = enroll, y = overall, color = mmr)) +
  geom_point() +
  coord_flip() +
  facet_wrap(~type)
```


##Histograms

```{r}
measles_mmr_pos %>% 
  ggplot(aes(x = mmr)) +
  geom_histogram(bins = 100)
```


```{r}
measles %>% 
  filter(xper <= 100) %>% 
  ggplot(aes(x = xper)) +
  geom_histogram(bins = 100)
``` 

##Mean MMR vaccination rates by state (bar) *using new data frame

```{r}
mean_mmr_by_state
```
##How can I facet wrap this by type? Try One for each state? I get Label errors.
```{r}
ggplot(data = mean_mmr_by_state,
       mapping = aes(x = mean_mmr_rate, y = state))+
  geom_bar(stat = "identity") 
```


##Bar Charts v1: Number of Reporting Schools, by Type

```{r}
measles %>% 
  drop_na(type) %>% 
  ggplot(aes(x = type, fill = type)) +
  geom_bar(show.legend = FALSE) +
  scale_fill_brewer(palette = "Set3") 
```


#Bar Chart v2 MMR by school type

```{r}
mmr_by_type <- measles_mmr_pos %>% 
  drop_na(type) %>% 
  group_by(type) %>% 
  summarize(mean_mmr = mean(mmr, na.rm = TRUE))
```

```{r}
mmr_by_type
```

```{r}
mean_mmr_by_type <- mmr_by_type %>% 
  mutate(mmr_type_one_dig = format(round(mean_mmr, 1), nsmall = 1))
```

##When I updated the packages for the exercises in my data viz fundamentals file, suddenly my bars in this measles had a blue outline. How do I get them to match the fill? Do I need a specific theme library installed, like the hrbr one from the exercise? Why is my devtools packate not checked in Rstudio? I'd love more theme options like wsj and economist!

##Also can I facet wrap this by state? I got Layer errors. I couldn't figure out what to test facet wrap this with. 

```{r}
#install.packages("devtools")
library(devtools)
```


```{r}
ggplot(data = mean_mmr_by_type,
       mapping = aes(x = type, y= mean_mmr, fill = type)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  scale_fill_brewer(palette = "Set3") +
  geom_text(aes(label = mmr_type_one_dig),
          vjust = 1.5,
            show.legend = FALSE,
            color = "black") +
  labs(title = "Average MMR Vaccination Rates by School Type",
       x = "School Type",
       y = "Average MMR Rate") +
    theme_classic() 

  

 
```

```{r}
ggsave(filename = "plots/avg-mmr-by-type.png",
       height = 5,
       width = 8,
       units = "in")
```

##Make a graph of mean mmr rates by State, then facet by type?

# States with Vaccination Rates below WHO-recommended 95%


